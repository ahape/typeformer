From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Bailey <5341706+jakebailey@users.noreply.github.com>
Date: Tue, 13 Sep 2022 11:26:41 -0700
Subject: [PATCH] Fix up api-extractor configs, add Gulp task

---
 Gulpfile.js                                  | 20 +++++++
 package-lock.json                            | 14 ++---
 package.json                                 |  2 +-
 src/api-extractor-base.json                  | 24 +++-----
 src/tsserverlibrary/api-extractor.json       | 16 +++++
 src/tsserverlibrary/tsserverlibrary.ts       |  6 +-
 src/typescript/api-extractor.json            | 61 +++-----------------
 src/typescript/typescript.ts                 |  2 -
 src/typescriptServices/api-extractor.json    | 16 +++++
 src/typescriptServices/typescriptServices.ts |  5 +-
 10 files changed, 80 insertions(+), 86 deletions(-)
 create mode 100644 src/tsserverlibrary/api-extractor.json
 create mode 100644 src/typescriptServices/api-extractor.json

diff --git a/Gulpfile.js b/Gulpfile.js
index bb87b72a89..7b2637f03b 100644
--- a/Gulpfile.js
+++ b/Gulpfile.js
@@ -98,6 +98,26 @@ const buildAll = () => buildProject("src");
 
 task("moduleBuild", parallel(generateLibs, series(buildScripts, localize, buildAll)));
 
+
+const apiExtractor = async () => {
+    async function runApiExtractor(configPath) {
+        await exec(process.execPath, [
+            "node_modules/@microsoft/api-extractor/bin/api-extractor",
+            "run",
+            "--local",
+            "--config",
+            configPath,
+        ]);
+    }
+
+    // TODO(jakebailey): prepend copyright notice, replace const enums with regular enums
+    await runApiExtractor("./src/typescript/api-extractor.json");
+    await runApiExtractor("./src/tsserverlibrary/api-extractor.json");
+    await runApiExtractor("./src/typescriptServices/api-extractor.json");
+};
+
+task("api-extractor", series(task("moduleBuild"), apiExtractor));
+
 const buildDebugTools = () => buildProject("src/debug");
 const cleanDebugTools = () => cleanProject("src/debug");
 cleanTasks.push(cleanDebugTools);
diff --git a/package-lock.json b/package-lock.json
index b428f5bfc0..78018b1601 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -13,7 +13,7 @@
                 "tsserver": "bin/tsserver"
             },
             "devDependencies": {
-                "@microsoft/api-extractor": "^7.30.0",
+                "@microsoft/api-extractor": "^7.31.0",
                 "@octokit/rest": "latest",
                 "@types/async": "latest",
                 "@types/chai": "latest",
@@ -219,9 +219,9 @@
             "dev": true
         },
         "node_modules/@microsoft/api-extractor": {
-            "version": "7.30.1",
-            "resolved": "https://registry.npmjs.org/@microsoft/api-extractor/-/api-extractor-7.30.1.tgz",
-            "integrity": "sha512-RXpBcshikKl0vVx292JC1A0l6SXITS9YBFPv3hnWvXj79Q5KbLdonvfAljnpK/RSrCzot14I1kUE90J0vcYE3Q==",
+            "version": "7.31.0",
+            "resolved": "https://registry.npmjs.org/@microsoft/api-extractor/-/api-extractor-7.31.0.tgz",
+            "integrity": "sha512-1gVDvm/eKmntBn5X5Rc+XDREm9gfxQ/BQfGFf7Rf4uWvJc4Q4GxidC3lBODYDOcikjG983bzbo0xTu5BS8J93Q==",
             "dev": true,
             "dependencies": {
                 "@microsoft/api-extractor-model": "7.24.0",
@@ -8893,9 +8893,9 @@
             "dev": true
         },
         "@microsoft/api-extractor": {
-            "version": "7.30.1",
-            "resolved": "https://registry.npmjs.org/@microsoft/api-extractor/-/api-extractor-7.30.1.tgz",
-            "integrity": "sha512-RXpBcshikKl0vVx292JC1A0l6SXITS9YBFPv3hnWvXj79Q5KbLdonvfAljnpK/RSrCzot14I1kUE90J0vcYE3Q==",
+            "version": "7.31.0",
+            "resolved": "https://registry.npmjs.org/@microsoft/api-extractor/-/api-extractor-7.31.0.tgz",
+            "integrity": "sha512-1gVDvm/eKmntBn5X5Rc+XDREm9gfxQ/BQfGFf7Rf4uWvJc4Q4GxidC3lBODYDOcikjG983bzbo0xTu5BS8J93Q==",
             "dev": true,
             "requires": {
                 "@microsoft/api-extractor-model": "7.24.0",
diff --git a/package.json b/package.json
index d8f17a20c7..bfdf548e27 100644
--- a/package.json
+++ b/package.json
@@ -39,7 +39,7 @@
         "!**/.gitattributes"
     ],
     "devDependencies": {
-        "@microsoft/api-extractor": "^7.30.0",
+        "@microsoft/api-extractor": "^7.31.0",
         "@octokit/rest": "latest",
         "@types/async": "latest",
         "@types/chai": "latest",
diff --git a/src/api-extractor-base.json b/src/api-extractor-base.json
index 23c09a590f..19a8384dbd 100644
--- a/src/api-extractor-base.json
+++ b/src/api-extractor-base.json
@@ -2,21 +2,7 @@
  * Config file for API Extractor.  For more info, please visit: https://api-extractor.com
  */
  {
-    "$schema": "https://developer.microsoft.com/json-schemas/api-extractor/v7/api-extractor.schema.json",
-  
-    /**
-     * Optionally specifies another JSON config file that this file extends from.  This provides a way for
-     * standard settings to be shared across multiple projects.
-     *
-     * If the path starts with "./" or "../", the path is resolved relative to the folder of the file that contains
-     * the "extends" field.  Otherwise, the first path segment is interpreted as an NPM package name, and will be
-     * resolved using NodeJS require().
-     *
-     * SUPPORTED TOKENS: none
-     * DEFAULT VALUE: ""
-     */
-    // "extends": "./shared/api-extractor-base.json"
-    // "extends": "my-package/include/api-extractor-base.json"
+    "$schema": "https://raw.githubusercontent.com/microsoft/rushstack/%40microsoft/api-extractor_v7.31.0/apps/api-extractor/src/schemas/api-extractor.schema.json",
   
     /**
      * Determines the "<projectFolder>" token that can be used with other config file settings.  The project folder
@@ -135,7 +121,6 @@
       /**
        * (REQUIRED) Whether to generate an API report.
        */
-    //   "enabled": true
       "enabled": false
   
       /**
@@ -196,7 +181,6 @@
       /**
        * (REQUIRED) Whether to generate a doc model file.
        */
-    //   "enabled": true
       "enabled": false
   
       /**
@@ -396,6 +380,12 @@
         "ae-unresolved-link": {
           "logLevel": "none",
           "addToApiReportFile": false
+        },
+
+        // This incorrectly fires for functions with partially internal overloads.
+        "ae-internal-mixed-release-tag": {
+          "logLevel": "none",
+          "addToApiReportFile": false
         }
   
         // "ae-extra-release-tag": {
diff --git a/src/tsserverlibrary/api-extractor.json b/src/tsserverlibrary/api-extractor.json
new file mode 100644
index 0000000000..3f3ba43259
--- /dev/null
+++ b/src/tsserverlibrary/api-extractor.json
@@ -0,0 +1,16 @@
+{
+    "$schema": "https://raw.githubusercontent.com/microsoft/rushstack/%40microsoft/api-extractor_v7.31.0/apps/api-extractor/src/schemas/api-extractor.schema.json",
+    "extends": "../api-extractor-base.json",
+    "compiler": {
+        "tsconfigFilePath": "./tsconfig.json"
+    },
+
+    "mainEntryPointFilePath": "<projectFolder>/built/local/tsserverlibrary/tsserverlibrary.d.ts",
+
+    "dtsRollup": {
+        "enabled": true,
+        "publicTrimmedFilePath": "<projectFolder>/built/local/tsserverlibrary.d.ts",
+        "untrimmedFilePath": "<projectFolder>/built/local/tsserverlibrary.internal.d.ts"
+    }
+}
+  
\ No newline at end of file
diff --git a/src/tsserverlibrary/tsserverlibrary.ts b/src/tsserverlibrary/tsserverlibrary.ts
index bd73794b37..caa2e6b1db 100644
--- a/src/tsserverlibrary/tsserverlibrary.ts
+++ b/src/tsserverlibrary/tsserverlibrary.ts
@@ -1,5 +1 @@
-import * as ts from "./_namespaces/ts";
-
-// TODO(jakebailey): replace const enum with enum in d.ts
-
-export = ts;
+export * from "./_namespaces/ts";
diff --git a/src/typescript/api-extractor.json b/src/typescript/api-extractor.json
index 44979b5524..60231b6911 100644
--- a/src/typescript/api-extractor.json
+++ b/src/typescript/api-extractor.json
@@ -1,59 +1,16 @@
-/**
- * Config file for API Extractor.  For more info, please visit: https://api-extractor.com
- */
- {
-    "$schema": "https://developer.microsoft.com/json-schemas/api-extractor/v7/api-extractor.schema.json",
-  
-    /**
-     * Optionally specifies another JSON config file that this file extends from.  This provides a way for
-     * standard settings to be shared across multiple projects.
-     *
-     * If the path starts with "./" or "../", the path is resolved relative to the folder of the file that contains
-     * the "extends" field.  Otherwise, the first path segment is interpreted as an NPM package name, and will be
-     * resolved using NodeJS require().
-     *
-     * SUPPORTED TOKENS: none
-     * DEFAULT VALUE: ""
-     */
+{
+    "$schema": "https://raw.githubusercontent.com/microsoft/rushstack/%40microsoft/api-extractor_v7.31.0/apps/api-extractor/src/schemas/api-extractor.schema.json",
     "extends": "../api-extractor-base.json",
-
-    /**
-     * Determines how the TypeScript compiler engine will be invoked by API Extractor.
-     */
-     "compiler": {
-      /**
-       * Specifies the path to the tsconfig.json file to be used by API Extractor when analyzing the project.
-       *
-       * The path is resolved relative to the folder of the config file that contains the setting; to change this,
-       * prepend a folder token such as "<projectFolder>".
-       *
-       * Note: This setting will be ignored if "overrideTsconfig" is used.
-       *
-       * SUPPORTED TOKENS: <projectFolder>, <packageName>, <unscopedPackageName>
-       * DEFAULT VALUE: "<projectFolder>/tsconfig.json"
-       */
-      "tsconfigFilePath": "./tsconfig.json"
+    "compiler": {
+        "tsconfigFilePath": "./tsconfig.json"
     },
-  
-    /**
-     * (REQUIRED) Specifies the .d.ts file to be used as the starting point for analysis.  API Extractor
-     * analyzes the symbols exported by this module.
-     *
-     * The file extension must be ".d.ts" and not ".ts".
-     *
-     * The path is resolved relative to the folder of the config file that contains the setting; to change this,
-     * prepend a folder token such as "<projectFolder>".
-     *
-     * SUPPORTED TOKENS: <projectFolder>, <packageName>, <unscopedPackageName>
-     */
+
     "mainEntryPointFilePath": "<projectFolder>/built/local/typescript/typescript.d.ts",
 
     "dtsRollup": {
-      /**
-       * (REQUIRED) Whether to generate the .d.ts rollup file.
-       */
-      "enabled": true,
-      "publicTrimmedFilePath": "<projectFolder>/built/local/typescript.d.ts"
+        "enabled": true,
+        "publicTrimmedFilePath": "<projectFolder>/built/local/typescript.d.ts",
+        "untrimmedFilePath": "<projectFolder>/built/local/typescript.internal.d.ts"
     }
-  }
+}
   
\ No newline at end of file
diff --git a/src/typescript/typescript.ts b/src/typescript/typescript.ts
index dd5007e2d0..8a5136a1eb 100644
--- a/src/typescript/typescript.ts
+++ b/src/typescript/typescript.ts
@@ -1,7 +1,5 @@
 import { Debug, LogLevel } from "./_namespaces/ts";
 
-// TODO(jakebailey): replace const enum with enum in d.ts
-
 // enable deprecation logging
 declare const console: any;
 if (typeof console !== "undefined") {
diff --git a/src/typescriptServices/api-extractor.json b/src/typescriptServices/api-extractor.json
new file mode 100644
index 0000000000..b245768aa3
--- /dev/null
+++ b/src/typescriptServices/api-extractor.json
@@ -0,0 +1,16 @@
+{
+    "$schema": "https://raw.githubusercontent.com/microsoft/rushstack/%40microsoft/api-extractor_v7.31.0/apps/api-extractor/src/schemas/api-extractor.schema.json",
+    "extends": "../api-extractor-base.json",
+    "compiler": {
+        "tsconfigFilePath": "./tsconfig.json"
+    },
+
+    "mainEntryPointFilePath": "<projectFolder>/built/local/typescriptServices/typescriptServices.d.ts",
+
+    "dtsRollup": {
+        "enabled": true,
+        "publicTrimmedFilePath": "<projectFolder>/built/local/typescriptServices.d.ts",
+        "untrimmedFilePath": "<projectFolder>/built/local/typescriptServices.internal.d.ts"
+    }
+}
+  
\ No newline at end of file
diff --git a/src/typescriptServices/typescriptServices.ts b/src/typescriptServices/typescriptServices.ts
index 1dacdf046e..6c5ea3cd98 100644
--- a/src/typescriptServices/typescriptServices.ts
+++ b/src/typescriptServices/typescriptServices.ts
@@ -1,6 +1,5 @@
 import { Debug, LogLevel } from "./_namespaces/ts";
-
-// TODO(jakebailey): replace const enum with enum in d.ts
+import * as _ts from "./_namespaces/ts";
 
 // enable deprecation logging
 declare const console: any;
@@ -16,3 +15,5 @@ if (typeof console !== "undefined") {
         }
     };
 }
+
+// TODO(jakebailey): what does this export?
-- 
2.37.1

