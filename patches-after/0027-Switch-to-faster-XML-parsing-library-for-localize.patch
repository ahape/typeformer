From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Bailey <5341706+jakebailey@users.noreply.github.com>
Date: Sun, 9 Oct 2022 20:43:20 -0700
Subject: [PATCH] Switch to faster XML parsing library for localize

Switching to a newer/faster/maintained library speeds up this script by
more than 50%. We can also eliminate some any and such in the process.
---
 package-lock.json                             | 110 +++++++-----------
 package.json                                  |   7 +-
 .../generateLocalizedDiagnosticMessages.mjs   |  47 +++++---
 3 files changed, 75 insertions(+), 89 deletions(-)

diff --git a/package-lock.json b/package-lock.json
index 2bd4a8439d..cdd7fc7ea7 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -25,7 +25,6 @@
                 "@types/node": "latest",
                 "@types/source-map-support": "latest",
                 "@types/which": "^2.0.1",
-                "@types/xml2js": "^0.4.11",
                 "@typescript-eslint/eslint-plugin": "^5.33.1",
                 "@typescript-eslint/parser": "^5.33.1",
                 "@typescript-eslint/utils": "^5.33.1",
@@ -41,6 +40,7 @@
                 "eslint-plugin-jsdoc": "^39.3.6",
                 "eslint-plugin-local": "^1.0.0",
                 "eslint-plugin-no-null": "^1.0.2",
+                "fast-xml-parser": "^4.0.11",
                 "fs-extra": "^9.1.0",
                 "glob": "latest",
                 "hereby": "^1.5.0",
@@ -53,8 +53,7 @@
                 "node-fetch": "^3.2.10",
                 "source-map-support": "latest",
                 "typescript": "^4.8.4",
-                "which": "^2.0.2",
-                "xml2js": "^0.4.23"
+                "which": "^2.0.2"
             },
             "engines": {
                 "node": ">=4.2.0"
@@ -473,15 +472,6 @@
             "integrity": "sha512-Jjakcv8Roqtio6w1gr0D7y6twbhx6gGgFGF5BLwajPpnOIOxFkakFhCq+LmyyeAz7BX6ULrjBOxdKaCDy+4+dQ==",
             "dev": true
         },
-        "node_modules/@types/xml2js": {
-            "version": "0.4.11",
-            "resolved": "https://registry.npmjs.org/@types/xml2js/-/xml2js-0.4.11.tgz",
-            "integrity": "sha512-JdigeAKmCyoJUiQljjr7tQG3if9NkqGUgwEUqBvV0N7LM4HyQk7UXCnusRa1lnvXAEYJ8mw8GtZWioagNztOwA==",
-            "dev": true,
-            "dependencies": {
-                "@types/node": "*"
-            }
-        },
         "node_modules/@typescript-eslint/eslint-plugin": {
             "version": "5.40.0",
             "resolved": "https://registry.npmjs.org/@typescript-eslint/eslint-plugin/-/eslint-plugin-5.40.0.tgz",
@@ -2158,6 +2148,22 @@
             "integrity": "sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==",
             "dev": true
         },
+        "node_modules/fast-xml-parser": {
+            "version": "4.0.11",
+            "resolved": "https://registry.npmjs.org/fast-xml-parser/-/fast-xml-parser-4.0.11.tgz",
+            "integrity": "sha512-4aUg3aNRR/WjQAcpceODG1C3x3lFANXRo8+1biqfieHmg9pyMt7qB4lQV/Ta6sJCTbA5vfD8fnA8S54JATiFUA==",
+            "dev": true,
+            "dependencies": {
+                "strnum": "^1.0.5"
+            },
+            "bin": {
+                "fxparser": "src/cli/cli.js"
+            },
+            "funding": {
+                "type": "paypal",
+                "url": "https://paypal.me/naturalintelligence"
+            }
+        },
         "node_modules/fastest-levenshtein": {
             "version": "1.0.16",
             "resolved": "https://registry.npmjs.org/fastest-levenshtein/-/fastest-levenshtein-1.0.16.tgz",
@@ -3968,12 +3974,6 @@
                 "url": "https://github.com/sponsors/ljharb"
             }
         },
-        "node_modules/sax": {
-            "version": "1.2.4",
-            "resolved": "https://registry.npmjs.org/sax/-/sax-1.2.4.tgz",
-            "integrity": "sha512-NqVDv9TpANUjFm0N8uM5GxL36UgKi9/atZw+x7YFnQ8ckwFGKrl4xX4yWtrey3UJm5nP1kUbnYgLopqWNSRhWw==",
-            "dev": true
-        },
         "node_modules/semver": {
             "version": "7.3.8",
             "resolved": "https://registry.npmjs.org/semver/-/semver-7.3.8.tgz",
@@ -4150,6 +4150,12 @@
                 "url": "https://github.com/sponsors/sindresorhus"
             }
         },
+        "node_modules/strnum": {
+            "version": "1.0.5",
+            "resolved": "https://registry.npmjs.org/strnum/-/strnum-1.0.5.tgz",
+            "integrity": "sha512-J8bbNyKKXl5qYcR36TIO8W3mVGVHrmmxsd5PAItGkmyzwJvybiw2IVq5nqd0i4LSNSkB/sx9VHllbfFdr9k1JA==",
+            "dev": true
+        },
         "node_modules/supports-color": {
             "version": "7.2.0",
             "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
@@ -4483,28 +4489,6 @@
             "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==",
             "dev": true
         },
-        "node_modules/xml2js": {
-            "version": "0.4.23",
-            "resolved": "https://registry.npmjs.org/xml2js/-/xml2js-0.4.23.tgz",
-            "integrity": "sha512-ySPiMjM0+pLDftHgXY4By0uswI3SPKLDw/i3UXbnO8M/p28zqexCUoPmQFrYD+/1BzhGJSs2i1ERWKJAtiLrug==",
-            "dev": true,
-            "dependencies": {
-                "sax": ">=0.6.0",
-                "xmlbuilder": "~11.0.0"
-            },
-            "engines": {
-                "node": ">=4.0.0"
-            }
-        },
-        "node_modules/xmlbuilder": {
-            "version": "11.0.1",
-            "resolved": "https://registry.npmjs.org/xmlbuilder/-/xmlbuilder-11.0.1.tgz",
-            "integrity": "sha512-fDlsI/kFEx7gLvbecc0/ohLG50fugQp8ryHzMTuW9vSa1GJ0XYWKnhsUx7oie3G98+r56aTQIUB4kht42R3JvA==",
-            "dev": true,
-            "engines": {
-                "node": ">=4.0"
-            }
-        },
         "node_modules/yallist": {
             "version": "4.0.0",
             "resolved": "https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz",
@@ -4896,15 +4880,6 @@
             "integrity": "sha512-Jjakcv8Roqtio6w1gr0D7y6twbhx6gGgFGF5BLwajPpnOIOxFkakFhCq+LmyyeAz7BX6ULrjBOxdKaCDy+4+dQ==",
             "dev": true
         },
-        "@types/xml2js": {
-            "version": "0.4.11",
-            "resolved": "https://registry.npmjs.org/@types/xml2js/-/xml2js-0.4.11.tgz",
-            "integrity": "sha512-JdigeAKmCyoJUiQljjr7tQG3if9NkqGUgwEUqBvV0N7LM4HyQk7UXCnusRa1lnvXAEYJ8mw8GtZWioagNztOwA==",
-            "dev": true,
-            "requires": {
-                "@types/node": "*"
-            }
-        },
         "@typescript-eslint/eslint-plugin": {
             "version": "5.40.0",
             "resolved": "https://registry.npmjs.org/@typescript-eslint/eslint-plugin/-/eslint-plugin-5.40.0.tgz",
@@ -6042,6 +6017,15 @@
             "integrity": "sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==",
             "dev": true
         },
+        "fast-xml-parser": {
+            "version": "4.0.11",
+            "resolved": "https://registry.npmjs.org/fast-xml-parser/-/fast-xml-parser-4.0.11.tgz",
+            "integrity": "sha512-4aUg3aNRR/WjQAcpceODG1C3x3lFANXRo8+1biqfieHmg9pyMt7qB4lQV/Ta6sJCTbA5vfD8fnA8S54JATiFUA==",
+            "dev": true,
+            "requires": {
+                "strnum": "^1.0.5"
+            }
+        },
         "fastest-levenshtein": {
             "version": "1.0.16",
             "resolved": "https://registry.npmjs.org/fastest-levenshtein/-/fastest-levenshtein-1.0.16.tgz",
@@ -7298,12 +7282,6 @@
                 "is-regex": "^1.1.4"
             }
         },
-        "sax": {
-            "version": "1.2.4",
-            "resolved": "https://registry.npmjs.org/sax/-/sax-1.2.4.tgz",
-            "integrity": "sha512-NqVDv9TpANUjFm0N8uM5GxL36UgKi9/atZw+x7YFnQ8ckwFGKrl4xX4yWtrey3UJm5nP1kUbnYgLopqWNSRhWw==",
-            "dev": true
-        },
         "semver": {
             "version": "7.3.8",
             "resolved": "https://registry.npmjs.org/semver/-/semver-7.3.8.tgz",
@@ -7441,6 +7419,12 @@
             "integrity": "sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==",
             "dev": true
         },
+        "strnum": {
+            "version": "1.0.5",
+            "resolved": "https://registry.npmjs.org/strnum/-/strnum-1.0.5.tgz",
+            "integrity": "sha512-J8bbNyKKXl5qYcR36TIO8W3mVGVHrmmxsd5PAItGkmyzwJvybiw2IVq5nqd0i4LSNSkB/sx9VHllbfFdr9k1JA==",
+            "dev": true
+        },
         "supports-color": {
             "version": "7.2.0",
             "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
@@ -7699,22 +7683,6 @@
             "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==",
             "dev": true
         },
-        "xml2js": {
-            "version": "0.4.23",
-            "resolved": "https://registry.npmjs.org/xml2js/-/xml2js-0.4.23.tgz",
-            "integrity": "sha512-ySPiMjM0+pLDftHgXY4By0uswI3SPKLDw/i3UXbnO8M/p28zqexCUoPmQFrYD+/1BzhGJSs2i1ERWKJAtiLrug==",
-            "dev": true,
-            "requires": {
-                "sax": ">=0.6.0",
-                "xmlbuilder": "~11.0.0"
-            }
-        },
-        "xmlbuilder": {
-            "version": "11.0.1",
-            "resolved": "https://registry.npmjs.org/xmlbuilder/-/xmlbuilder-11.0.1.tgz",
-            "integrity": "sha512-fDlsI/kFEx7gLvbecc0/ohLG50fugQp8ryHzMTuW9vSa1GJ0XYWKnhsUx7oie3G98+r56aTQIUB4kht42R3JvA==",
-            "dev": true
-        },
         "yallist": {
             "version": "4.0.0",
             "resolved": "https://registry.npmjs.org/yallist/-/yallist-4.0.0.tgz",
diff --git a/package.json b/package.json
index 1a164cbd67..bc0c36dba1 100644
--- a/package.json
+++ b/package.json
@@ -51,7 +51,6 @@
         "@types/node": "latest",
         "@types/source-map-support": "latest",
         "@types/which": "^2.0.1",
-        "@types/xml2js": "^0.4.11",
         "@typescript-eslint/eslint-plugin": "^5.33.1",
         "@typescript-eslint/parser": "^5.33.1",
         "@typescript-eslint/utils": "^5.33.1",
@@ -67,10 +66,11 @@
         "eslint-plugin-jsdoc": "^39.3.6",
         "eslint-plugin-local": "^1.0.0",
         "eslint-plugin-no-null": "^1.0.2",
+        "fast-xml-parser": "^4.0.11",
         "fs-extra": "^9.1.0",
         "glob": "latest",
-        "jsonc-parser": "^3.2.0",
         "hereby": "^1.5.0",
+        "jsonc-parser": "^3.2.0",
         "minimist": "latest",
         "mkdirp": "latest",
         "mocha": "latest",
@@ -79,8 +79,7 @@
         "node-fetch": "^3.2.10",
         "source-map-support": "latest",
         "typescript": "^4.8.4",
-        "which": "^2.0.2",
-        "xml2js": "^0.4.23"
+        "which": "^2.0.2"
     },
     "scripts": {
         "test": "hereby runtests-parallel --light=false",
diff --git a/scripts/generateLocalizedDiagnosticMessages.mjs b/scripts/generateLocalizedDiagnosticMessages.mjs
index 73c30e8615..45e393fc3e 100644
--- a/scripts/generateLocalizedDiagnosticMessages.mjs
+++ b/scripts/generateLocalizedDiagnosticMessages.mjs
@@ -1,9 +1,26 @@
 import fs from "fs";
 import path from "path";
-import xml2js from "xml2js";
-import util from "util";
-
-const parseString = util.promisify(xml2js.parseString);
+import { XMLParser } from "fast-xml-parser";
+
+/** @typedef {{
+    LCX: {
+        $_TgtCul: string;
+        Item: {
+            Item: {
+                Item: {
+                    $_ItemId: string;
+                    Str: {
+                        Val: string;
+                        Tgt: {
+                            Val: string;
+                        };
+                    };
+                }[];
+            };
+        };
+    }
+}} ParsedLCL */
+void 0;
 
 async function main() {
     const args = process.argv.slice(2);
@@ -31,15 +48,17 @@ async function main() {
      */
     async function visitDirectory(name) {
         const inputFilePath = path.join(inputPath, name, "diagnosticMessages", "diagnosticMessages.generated.json.lcl");
-        const contents = await fs.promises.readFile(inputFilePath, "utf-8");
-        const result = await parseString(contents);
-        if (!result || !result.LCX || !result.LCX.$ || !result.LCX.$.TgtCul) {
-            console.error("Unexpected XML file structure. Expected to find result.LCX.$.TgtCul.");
+        const contents = await fs.promises.readFile(inputFilePath);
+        /** @type {ParsedLCL} */
+        // eslint-disable-next-line local/object-literal-surrounding-space
+        const result = new XMLParser({ ignoreAttributes: false, attributeNamePrefix: "$_"}).parse(contents);
+        if (!result || !result.LCX || !result.LCX.$_TgtCul) {
+            console.error("Unexpected XML file structure. Expected to find result.LCX.$_TgtCul.");
             process.exit(1);
         }
-        const outputDirectoryName = getPreferredLocaleName(result.LCX.$.TgtCul).toLowerCase();
+        const outputDirectoryName = getPreferredLocaleName(result.LCX.$_TgtCul).toLowerCase();
         if (!outputDirectoryName) {
-            console.error(`Invalid output locale name for '${result.LCX.$.TgtCul}'.`);
+            console.error(`Invalid output locale name for '${result.LCX.$_TgtCul}'.`);
             process.exit(1);
         }
         await writeFile(path.join(outputPath, outputDirectoryName, "diagnosticMessages.generated.json"), xmlObjectToString(result));
@@ -77,14 +96,14 @@ async function main() {
     }
 
     /**
-     * @param {any} o
+     * @param {ParsedLCL} o
      */
     function xmlObjectToString(o) {
         /** @type {any} */
         const out = {};
-        for (const item of o.LCX.Item[0].Item[0].Item) {
-            let ItemId = item.$.ItemId;
-            let val = item.Str[0].Tgt ? item.Str[0].Tgt[0].Val[0] : item.Str[0].Val[0];
+        for (const item of o.LCX.Item.Item.Item) {
+            let ItemId = item.$_ItemId;
+            let val = item.Str.Tgt ? item.Str.Tgt.Val : item.Str.Val;
 
             if (typeof ItemId !== "string" || typeof val !== "string") {
                 console.error("Unexpected XML file structure");
-- 
2.38.0

