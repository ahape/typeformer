From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Bailey <5341706+jakebailey@users.noreply.github.com>
Date: Thu, 29 Sep 2022 21:11:55 -0700
Subject: [PATCH] Convert __require back to require for external bundlers

---
 Gulpfile.js                           |  6 +-
 package-lock.json                     | 83 +++++++++++++++++++++++++++
 package.json                          |  1 +
 scripts/build/removeEsbuildRequire.js | 23 ++++++++
 4 files changed, 111 insertions(+), 2 deletions(-)
 create mode 100644 scripts/build/removeEsbuildRequire.js

diff --git a/Gulpfile.js b/Gulpfile.js
index 3729da386c..85a57d038e 100644
--- a/Gulpfile.js
+++ b/Gulpfile.js
@@ -170,7 +170,7 @@ function esbuildTask(entrypoint, outfile, exportIsTsObject = false, performanceM
         platform: "node",
         target: "es2018", // This covers Node 10.
         format: "cjs",
-        sourcemap: true,
+        sourcemap: performanceMatters ? "inline" : "linked",
         external: ["./node_modules/*"],
         conditions: ["require"],
         supported: {
@@ -205,7 +205,9 @@ function esbuildTask(entrypoint, outfile, exportIsTsObject = false, performanceM
             if (performanceMatters) {
                 // TODO(jakebailey): we could use ts.transpileModule for this, but running babel is faster to get this singular transform.
                 // If we did use ts.transpileModule, we'd need ts.ScriptTarget.ES5, which also will downlevel arrow functions, for-of, spread, etc.
-                await exec(process.execPath, ["./node_modules/@babel/cli/bin/babel.js", preBabel, "--out-file", outfile, "--plugins", "@babel/plugin-transform-block-scoping", "--compact", "false", "--source-maps"]);
+                // Now I'm using this to remove __require from the esbuild output, so that would also require a port, but I can't quite figure out
+                // how to pipe source maps through transpileModule.
+                await exec(process.execPath, ["./node_modules/@babel/cli/bin/babel.js", preBabel, "--out-file", outfile, "--plugins", "@babel/plugin-transform-block-scoping,./scripts/build/removeEsbuildRequire", "--compact", "false", "--source-maps"]);
                 await del([preBabel, `${preBabel}.map`]);
             }
         },
diff --git a/package-lock.json b/package-lock.json
index e8adc58236..3918f7ca5b 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -17,6 +17,7 @@
                 "@babel/core": "^7.19.3",
                 "@babel/plugin-transform-block-scoping": "^7.18.9",
                 "@octokit/rest": "latest",
+                "@types/babel__core": "^7.1.19",
                 "@types/chai": "latest",
                 "@types/fs-extra": "^9.0.13",
                 "@types/glob": "latest",
@@ -1006,6 +1007,47 @@
                 "@octokit/openapi-types": "^13.11.0"
             }
         },
+        "node_modules/@types/babel__core": {
+            "version": "7.1.19",
+            "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.1.19.tgz",
+            "integrity": "sha512-WEOTgRsbYkvA/KCsDwVEGkd7WAr1e3g31VHQ8zy5gul/V1qKullU/BU5I68X5v7V3GnB9eotmom4v5a5gjxorw==",
+            "dev": true,
+            "dependencies": {
+                "@babel/parser": "^7.1.0",
+                "@babel/types": "^7.0.0",
+                "@types/babel__generator": "*",
+                "@types/babel__template": "*",
+                "@types/babel__traverse": "*"
+            }
+        },
+        "node_modules/@types/babel__generator": {
+            "version": "7.6.4",
+            "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.6.4.tgz",
+            "integrity": "sha512-tFkciB9j2K755yrTALxD44McOrk+gfpIpvC3sxHjRawj6PfnQxrse4Clq5y/Rq+G3mrBurMax/lG8Qn2t9mSsg==",
+            "dev": true,
+            "dependencies": {
+                "@babel/types": "^7.0.0"
+            }
+        },
+        "node_modules/@types/babel__template": {
+            "version": "7.4.1",
+            "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.1.tgz",
+            "integrity": "sha512-azBFKemX6kMg5Io+/rdGT0dkGreboUVR0Cdm3fz9QJWpaQGJRQXl7C+6hOTCZcMll7KFyEQpgbYI2lHdsS4U7g==",
+            "dev": true,
+            "dependencies": {
+                "@babel/parser": "^7.1.0",
+                "@babel/types": "^7.0.0"
+            }
+        },
+        "node_modules/@types/babel__traverse": {
+            "version": "7.18.2",
+            "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.18.2.tgz",
+            "integrity": "sha512-FcFaxOr2V5KZCviw1TnutEMVUVsGt4D2hP1TAfXZAMKuHYW3xQhe3jTxNPWutgCJ3/X1c5yX8ZoGVEItxKbwBg==",
+            "dev": true,
+            "dependencies": {
+                "@babel/types": "^7.3.0"
+            }
+        },
         "node_modules/@types/chai": {
             "version": "4.3.3",
             "resolved": "https://registry.npmjs.org/@types/chai/-/chai-4.3.3.tgz",
@@ -10357,6 +10399,47 @@
                 "@octokit/openapi-types": "^13.11.0"
             }
         },
+        "@types/babel__core": {
+            "version": "7.1.19",
+            "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.1.19.tgz",
+            "integrity": "sha512-WEOTgRsbYkvA/KCsDwVEGkd7WAr1e3g31VHQ8zy5gul/V1qKullU/BU5I68X5v7V3GnB9eotmom4v5a5gjxorw==",
+            "dev": true,
+            "requires": {
+                "@babel/parser": "^7.1.0",
+                "@babel/types": "^7.0.0",
+                "@types/babel__generator": "*",
+                "@types/babel__template": "*",
+                "@types/babel__traverse": "*"
+            }
+        },
+        "@types/babel__generator": {
+            "version": "7.6.4",
+            "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.6.4.tgz",
+            "integrity": "sha512-tFkciB9j2K755yrTALxD44McOrk+gfpIpvC3sxHjRawj6PfnQxrse4Clq5y/Rq+G3mrBurMax/lG8Qn2t9mSsg==",
+            "dev": true,
+            "requires": {
+                "@babel/types": "^7.0.0"
+            }
+        },
+        "@types/babel__template": {
+            "version": "7.4.1",
+            "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.1.tgz",
+            "integrity": "sha512-azBFKemX6kMg5Io+/rdGT0dkGreboUVR0Cdm3fz9QJWpaQGJRQXl7C+6hOTCZcMll7KFyEQpgbYI2lHdsS4U7g==",
+            "dev": true,
+            "requires": {
+                "@babel/parser": "^7.1.0",
+                "@babel/types": "^7.0.0"
+            }
+        },
+        "@types/babel__traverse": {
+            "version": "7.18.2",
+            "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.18.2.tgz",
+            "integrity": "sha512-FcFaxOr2V5KZCviw1TnutEMVUVsGt4D2hP1TAfXZAMKuHYW3xQhe3jTxNPWutgCJ3/X1c5yX8ZoGVEItxKbwBg==",
+            "dev": true,
+            "requires": {
+                "@babel/types": "^7.3.0"
+            }
+        },
         "@types/chai": {
             "version": "4.3.3",
             "resolved": "https://registry.npmjs.org/@types/chai/-/chai-4.3.3.tgz",
diff --git a/package.json b/package.json
index 361e6a55d2..79cd71e425 100644
--- a/package.json
+++ b/package.json
@@ -43,6 +43,7 @@
         "@babel/core": "^7.19.3",
         "@babel/plugin-transform-block-scoping": "^7.18.9",
         "@octokit/rest": "latest",
+        "@types/babel__core": "^7.1.19",
         "@types/chai": "latest",
         "@types/fs-extra": "^9.0.13",
         "@types/glob": "latest",
diff --git a/scripts/build/removeEsbuildRequire.js b/scripts/build/removeEsbuildRequire.js
new file mode 100644
index 0000000000..a2683f67dd
--- /dev/null
+++ b/scripts/build/removeEsbuildRequire.js
@@ -0,0 +1,23 @@
+module.exports = () => {
+    /** @type {import("@babel/core").PluginObj} */
+    const plugin = {
+        name: "remove-esbuild-require",
+        visitor: {
+            VariableDeclarator: (path) => {
+                const id = path.node.id;
+                if (id.type === "Identifier" && id.name === "__require") {
+                    path.remove();
+                }
+            },
+            CallExpression: (path) => {
+                // esbuild will transform require to __require, but that may trip up bundlers
+                // run on our own output, so convert them back,
+                const callee = path.node.callee;
+                if (callee.type === "Identifier" && callee.name === "__require") {
+                    callee.name = "require";
+                }
+            },
+        }
+    };
+    return plugin;
+};
-- 
2.37.3

